# Connector SDK (Gateway)

This SDK defines the stable interface that connector drivers must implement.
It is feature-flagged and safe to ship in 1.0.0.

## Driver contract
- Implement `Driver` from `com.neogenesis.gateway.connector`.
- Lifecycle: `init` -> `start` -> `readTelemetry` -> `stop`.
- Provide `capabilities`, `telemetrySchema`, and `manifest` (auto-generated by default).

## Minimal driver skeleton
```kotlin
class MyDriver : Driver {
    override val id = "my-driver"
    override val capabilities = setOf(Capability.Telemetry)
    override val telemetrySchema =
        TelemetrySchema(
            name = "my-schema",
            version = "1.0",
            fields = listOf(TelemetryField("value", "int", "unit")),
        )

    override suspend fun init(context: DriverContext) {}
    override suspend fun start() {}
    override suspend fun stop() {}
    override suspend fun health() = DriverHealth("ok")
    override suspend fun readTelemetry() =
        TelemetryEvent(Instant.now(), mapOf("value" to "42"))
}
```

## Capability manifest
Drivers expose a `ConnectorManifest` (auto-derived from `id`, `capabilities`, and `telemetrySchema`):
```kotlin
override val manifest = ConnectorManifest(
    id = id,
    name = "My Connector",
    version = "1.0.0",
    vendor = "Vendor",
    capabilities = capabilities,
    telemetrySchema = telemetrySchema,
    description = "Short description",
    configSchema = listOf(ConnectorConfigField("profile", "Profile name", defaultValue = "default")),
)
```

## Lifecycle
Use `ManagedDriver` to enforce lifecycle order and inspect state transitions:
```kotlin
val managed = ManagedDriver(MyDriver())
managed.init(context)
managed.start()
val state = managed.currentLifecycle()
```

## Timeouts
Wrap drivers with `SandboxedDriver` to enforce strict execution bounds:
```kotlin
val driver = SandboxedDriver(MyDriver(), DriverTimeouts.fromSingle(1_000))
```

## Simulated connector
Use the built-in simulated driver for validation:
```kotlin
val driver = SimulatedConnectorDriver()
```

## Running the simulated connector
The certification harness runs the connector inside `SandboxedDriver`, measures latency/drop/reconnect, and emits a JSON + Markdown report.

```bash
./gradlew :gateway:certifyConnector \
  -PconnectorCertArgs="--driver=simulated-connector --events=250 --dropRate=0.05 --reconnectAt=175 --output=build/reports/connector-certification"
```

Reports are stored under `build/reports/connector-certification/certification-report.{json,md}` and include mean/p95 latency, drop rate, reconnect attempts, and pass/warn/fail status. Swap `--driver=example-driver` (or your own driver ID) once it implements `Driver`.

For in-process validation, wrap `SimulatedConnectorDriver()` with `SandboxedDriver(..., timeoutMs = 1_000)` and observe `ManagedDriver.currentLifecycle()` while polling `readTelemetry()`.

## Configuration
Drivers receive:
- `tenantId`
- `correlationId`
- `config` (key/value map)

## Feature flag
Connector certification endpoints are guarded by:
- `CONNECTOR_CERTIFICATION_MODE=false` (default)
