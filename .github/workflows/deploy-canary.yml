name: Deploy Canary

on:
  workflow_call:
    inputs:
      image_tag:
        description: "Container image tag"
        required: true
        type: string
      namespace:
        description: "Kubernetes namespace"
        required: false
        default: "neogenesis"
        type: string
      rollout_name:
        description: "Argo Rollout name"
        required: false
        default: "neogenesis-core"
        type: string
      run_rollback_drill:
        description: "Run rollback drill (abort canary) instead of full promotion"
        required: false
        default: false
        type: boolean
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Container image tag"
        required: true
      namespace:
        description: "Kubernetes namespace"
        required: true
        default: "neogenesis"
      rollout_name:
        description: "Argo Rollout name"
        required: true
        default: "neogenesis-core"
      run_rollback_drill:
        description: "Run rollback drill (abort canary) instead of full promotion"
        required: true
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare evidence folders
        run: |
          set -euo pipefail
          TS="$(date -u +%Y%m%dT%H%M%SZ)"
          ROOT="evidence/canary-${TS}-${{ github.ref_name }}"
          mkdir -p "$ROOT"/{rollout,rollback,summary}
          echo "EVIDENCE_ROOT=$ROOT" >> "$GITHUB_ENV"

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup Argo Rollouts CLI
        run: |
          curl -sLO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > ~/.kube/config

      - name: Apply canary manifests
        run: |
          kubectl apply -f deploy/k8s/base/deployment.yaml
          kubectl apply -f deploy/k8s/canary/analysis-templates.yaml
          kubectl apply -f deploy/k8s/canary/rollout.yaml
          kubectl argo rollouts list -n "${{ inputs.namespace }}" > "${EVIDENCE_ROOT}/rollout/rollouts-before.txt"

      - name: Set image and execute rollout flow
        id: rollout
        run: |
          set -euo pipefail
          ROLLOUT="${{ inputs.rollout_name }}"
          NS="${{ inputs.namespace }}"
          IMAGE="ghcr.io/neogenesis/core-server:${{ inputs.image_tag }}"

          kubectl argo rollouts set image "$ROLLOUT" neogenesis-core="$IMAGE" -n "$NS" | tee "${EVIDENCE_ROOT}/rollout/set-image.txt"

          if [ "${{ inputs.run_rollback_drill }}" = "true" ]; then
            kubectl argo rollouts get rollout "$ROLLOUT" -n "$NS" --watch --timeout 5m | tee "${EVIDENCE_ROOT}/rollback/watch-before-abort.txt"
            kubectl argo rollouts abort "$ROLLOUT" -n "$NS" | tee "${EVIDENCE_ROOT}/rollback/abort.txt"
            kubectl argo rollouts get rollout "$ROLLOUT" -n "$NS" | tee "${EVIDENCE_ROOT}/rollback/status-after-abort.txt"
            echo "flow=rollback_drill" >> "$GITHUB_OUTPUT"
          else
            kubectl argo rollouts promote "$ROLLOUT" -n "$NS" | tee "${EVIDENCE_ROOT}/rollout/promote.txt"
            kubectl argo rollouts get rollout "$ROLLOUT" -n "$NS" --watch --timeout 20m | tee "${EVIDENCE_ROOT}/rollout/watch-promoted.txt"
            echo "flow=promoted" >> "$GITHUB_OUTPUT"
          fi

      - name: Auto rollback on failure
        if: failure()
        run: |
          set -euo pipefail
          ROLLOUT="${{ inputs.rollout_name }}"
          NS="${{ inputs.namespace }}"
          kubectl argo rollouts abort "$ROLLOUT" -n "$NS" | tee "${EVIDENCE_ROOT}/rollback/auto-abort.txt"
          kubectl argo rollouts get rollout "$ROLLOUT" -n "$NS" | tee "${EVIDENCE_ROOT}/rollback/auto-abort-status.txt"

      - name: Build rollout summary
        if: ${{ always() }}
        run: |
          set -euo pipefail
          SUMMARY="${EVIDENCE_ROOT}/summary/deploy-canary-summary.md"
          {
            echo "# Deploy Canary Summary"
            echo ""
            echo "- Branch: \`${GITHUB_REF_NAME}\`"
            echo "- Commit: \`${GITHUB_SHA}\`"
            echo "- Namespace: \`${{ inputs.namespace }}\`"
            echo "- Rollout: \`${{ inputs.rollout_name }}\`"
            echo "- Image tag: \`${{ inputs.image_tag }}\`"
            echo "- Flow: \`${{ steps.rollout.outputs.flow || 'failed_before_flow' }}\`"
            echo "- Rollback drill requested: \`${{ inputs.run_rollback_drill }}\`"
            echo "- Run URL: \`${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\`"
          } | tee "$SUMMARY"

      - name: Upload rollout evidence
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: canary-rollout-evidence-${{ github.run_id }}
          path: ${{ env.EVIDENCE_ROOT }}
          if-no-files-found: error
