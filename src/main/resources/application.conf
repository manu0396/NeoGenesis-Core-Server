ktor {
  deployment {
    port = 8080
    port = ${?NEOGENESIS_HTTP_PORT}
    port = ${?PORT}
    host = "0.0.0.0"
    host = ${?NEOGENESIS_HTTP_HOST}
  }
  application {
    modules = [ com.neogenesis.server.ApplicationKt.module ]
  }
}

neogenesis {
  runtime {
    environment = "development"
    environment = ${?NEOGENESIS_RUNTIME_ENVIRONMENT}
    environment = ${?ENV}
  }

  grpcPort = 50051
  grpcPort = ${?NEOGENESIS_GRPC_PORT}

  database {
    jdbcUrl = "jdbc:h2:mem:neogenesis;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE;DB_CLOSE_DELAY=-1"
    jdbcUrl = ${?NEOGENESIS_DB_JDBC_URL}
    jdbcUrl = ${?DB_URL}
    username = "sa"
    username = ${?NEOGENESIS_DB_USERNAME}
    username = ${?DB_USER}
    password = ""
    password = ${?NEOGENESIS_DB_PASSWORD}
    password = ${?DB_PASSWORD}
    maximumPoolSize = 10
    maximumPoolSize = ${?NEOGENESIS_DB_MAX_POOL_SIZE}
    maximumPoolSize = ${?DB_POOL_SIZE}
    connectionTimeoutMs = 3000
    connectionTimeoutMs = ${?NEOGENESIS_DB_CONNECTION_TIMEOUT_MS}
    validationTimeoutMs = 1000
    validationTimeoutMs = ${?NEOGENESIS_DB_VALIDATION_TIMEOUT_MS}
    idleTimeoutMs = 600000
    idleTimeoutMs = ${?NEOGENESIS_DB_IDLE_TIMEOUT_MS}
    maxLifetimeMs = 1800000
    maxLifetimeMs = ${?NEOGENESIS_DB_MAX_LIFETIME_MS}
    migrateOnStartup = true
  }

  mqtt {
    brokerUrl = ${?NEOGENESIS_MQTT_BROKER_URL}
    clientId = "neogenesis-core-server"
    clientId = ${?NEOGENESIS_MQTT_CLIENT_ID}
    topicRoot = "neogenesis/telemetry"
    topicRoot = ${?NEOGENESIS_MQTT_TOPIC_ROOT}
    username = ${?NEOGENESIS_MQTT_USERNAME}
    password = ${?NEOGENESIS_MQTT_PASSWORD}
  }

  clinical {
    validation {
      enforceStrict = true
      enforceStrict = ${?NEOGENESIS_CLINICAL_VALIDATION_STRICT}
      allowedFhirVersions = "R4,4.0.1"
      allowedFhirVersions = ${?NEOGENESIS_ALLOWED_FHIR_VERSIONS}
      requiredFhirProfiles = ""
      requiredFhirProfiles = ${?NEOGENESIS_REQUIRED_FHIR_PROFILES}
      requiredTerminologySystems = "http://loinc.org,http://snomed.info/sct"
      requiredTerminologySystems = ${?NEOGENESIS_REQUIRED_TERMINOLOGY_SYSTEMS}
      allowedHl7Versions = "2.3,2.4,2.5,2.5.1,2.6"
      allowedHl7Versions = ${?NEOGENESIS_ALLOWED_HL7_VERSIONS}
      allowedHl7MessageTypes = "ADT^A01,ADT^A08,ORM^O01,ORU^R01"
      allowedHl7MessageTypes = ${?NEOGENESIS_ALLOWED_HL7_TYPES}
    }

    dicomweb {
      enabled = false
      enabled = ${?NEOGENESIS_DICOMWEB_ENABLED}
      baseUrl = ${?NEOGENESIS_DICOMWEB_BASE_URL}
      bearerToken = ${?NEOGENESIS_DICOMWEB_BEARER_TOKEN}
      timeoutMs = 7000
      timeoutMs = ${?NEOGENESIS_DICOMWEB_TIMEOUT_MS}
    }

    dimse {
      enabled = false
      enabled = ${?NEOGENESIS_DIMSE_ENABLED}
      findScuPath = ${?NEOGENESIS_DIMSE_FINDSCU_PATH}
      moveScuPath = ${?NEOGENESIS_DIMSE_MOVESCU_PATH}
      getScuPath = ${?NEOGENESIS_DIMSE_GETSCU_PATH}
      callingAeTitle = "NEOGENESIS"
      callingAeTitle = ${?NEOGENESIS_DIMSE_CALLING_AET}
      calledAeTitle = "PACS"
      calledAeTitle = ${?NEOGENESIS_DIMSE_CALLED_AET}
      remoteHost = "127.0.0.1"
      remoteHost = ${?NEOGENESIS_DIMSE_REMOTE_HOST}
      remotePort = 104
      remotePort = ${?NEOGENESIS_DIMSE_REMOTE_PORT}
      localStorePath = ${?NEOGENESIS_DIMSE_LOCAL_STORE_PATH}
    }

    hl7Mllp {
      enabled = false
      enabled = ${?NEOGENESIS_HL7_MLLP_ENABLED}
      host = "0.0.0.0"
      host = ${?NEOGENESIS_HL7_MLLP_HOST}
      port = 2575
      port = ${?NEOGENESIS_HL7_MLLP_PORT}
      maxFrameBytes = 2000000
      maxFrameBytes = ${?NEOGENESIS_HL7_MLLP_MAX_FRAME_BYTES}
      connectTimeoutMs = 3000
      connectTimeoutMs = ${?NEOGENESIS_HL7_MLLP_CONNECT_TIMEOUT_MS}
      readTimeoutMs = 5000
      readTimeoutMs = ${?NEOGENESIS_HL7_MLLP_READ_TIMEOUT_MS}
    }
  }

  security {
    jwt {
      realm = "NeoGenesis"
      realm = ${?JWT_REALM}
      issuer = "neogenesis-auth"
      issuer = ${?NEOGENESIS_JWT_ISSUER}
      issuer = ${?JWT_ISSUER}
      audience = "neogenesis-api"
      audience = ${?NEOGENESIS_JWT_AUDIENCE}
      audience = ${?JWT_AUDIENCE}
      ttlSeconds = 3600
      ttlSeconds = ${?JWT_TTL_SECONDS}
      mode = "hmac"
      mode = ${?NEOGENESIS_JWT_MODE}
      jwksUrl = ${?NEOGENESIS_JWKS_URL}
      jwksUrl = ${?JWT_JWKS_URL}
      secret = "dev-only-secret-change-me"
      secret = ${?NEOGENESIS_JWT_SECRET}
      secret = ${?JWT_SECRET}
    }

    mtls {
      grpc {
        enabled = false
        enabled = ${?NEOGENESIS_MTLS_GRPC_ENABLED}
        requireClientAuth = true
        requireClientAuth = ${?NEOGENESIS_MTLS_GRPC_REQUIRE_CLIENT_AUTH}
        certChainPath = ${?NEOGENESIS_MTLS_GRPC_CERT_CHAIN_PATH}
        privateKeyPath = ${?NEOGENESIS_MTLS_GRPC_PRIVATE_KEY_PATH}
        trustCertPath = ${?NEOGENESIS_MTLS_GRPC_TRUST_CERT_PATH}
        hotReloadEnabled = true
        hotReloadEnabled = ${?NEOGENESIS_MTLS_GRPC_HOT_RELOAD_ENABLED}
        hotReloadIntervalMinutes = 60
        hotReloadIntervalMinutes = ${?NEOGENESIS_MTLS_GRPC_HOT_RELOAD_INTERVAL_MINUTES}
      }
      mqtt {
        enabled = false
        enabled = ${?NEOGENESIS_MTLS_MQTT_ENABLED}
        keyStorePath = ${?NEOGENESIS_MTLS_MQTT_KEYSTORE_PATH}
        keyStorePassword = ${?NEOGENESIS_MTLS_MQTT_KEYSTORE_PASSWORD}
        trustStorePath = ${?NEOGENESIS_MTLS_MQTT_TRUSTSTORE_PATH}
        trustStorePassword = ${?NEOGENESIS_MTLS_MQTT_TRUSTSTORE_PASSWORD}
      }
      httpProxyValidation {
        enabled = false
        enabled = ${?NEOGENESIS_HTTP_MTLS_PROXY_VALIDATION_ENABLED}
        verifyHeaderName = "x-ssl-client-verify"
        verifySuccessValue = "SUCCESS"
      }
    }
  }

  cors {
    allowedOrigins = ${?CORS_ALLOWED_ORIGINS}
  }

  rateLimits {
    authAttemptsPerMinute = 10
    authAttemptsPerMinute = ${?RATE_LIMIT_AUTH_PER_MINUTE}
    telemetryWritesPerMinute = 600
    telemetryWritesPerMinute = ${?RATE_LIMIT_TELEMETRY_PER_MINUTE}
    twinWritesPerMinute = 300
    twinWritesPerMinute = ${?RATE_LIMIT_TWIN_PER_MINUTE}
    maxRequestBodyBytes = 1000000
    maxRequestBodyBytes = ${?MAX_REQUEST_BODY_BYTES}
    requestTimeoutMs = 10000
    requestTimeoutMs = ${?REQUEST_TIMEOUT_MS}
  }

  adminBootstrap {
    enabled = false
    enabled = ${?ADMIN_BOOTSTRAP_ENABLED}
    user = ${?ADMIN_BOOTSTRAP_USER}
    password = ${?ADMIN_BOOTSTRAP_PASSWORD}
    passwordHash = ${?ADMIN_BOOTSTRAP_PASSWORD_HASH}
  }

  secrets {
    vault {
      enabled = false
      enabled = ${?NEOGENESIS_VAULT_ENABLED}
      address = ${?NEOGENESIS_VAULT_ADDRESS}
      token = ${?NEOGENESIS_VAULT_TOKEN}
      mount = "secret"
      mount = ${?NEOGENESIS_VAULT_MOUNT}
      timeoutMs = 5000
      timeoutMs = ${?NEOGENESIS_VAULT_TIMEOUT_MS}
    }
    kms {
      enabled = false
      enabled = ${?NEOGENESIS_KMS_ENABLED}
      region = "eu-west-1"
      region = ${?NEOGENESIS_KMS_REGION}
      endpointOverride = ${?NEOGENESIS_KMS_ENDPOINT_OVERRIDE}
    }
  }

  encryption {
    enabled = false
    enabled = ${?NEOGENESIS_ENCRYPTION_ENABLED}
    phiKeyRef = "env:NEOGENESIS_PHI_KEY_B64"
    phiKeyRef = ${?NEOGENESIS_PHI_KEY_REF}
    piiKeyRef = "env:NEOGENESIS_PII_KEY_B64"
    piiKeyRef = ${?NEOGENESIS_PII_KEY_REF}
  }

  gdpr {
    enforceConsent = false
    enforceConsent = ${?NEOGENESIS_GDPR_ENFORCE_CONSENT}
    defaultRetentionDays = 3650
    defaultRetentionDays = ${?NEOGENESIS_GDPR_DEFAULT_RETENTION_DAYS}
  }

  observability {
    metricsPath = "/metrics"
    metricsPath = ${?NEOGENESIS_METRICS_PATH}
    otlpEndpoint = ${?NEOGENESIS_OTLP_ENDPOINT}
    serviceName = "neogenesis-core-server"
    serviceName = ${?NEOGENESIS_OTLP_SERVICE_NAME}
  }

  resilience {
    enabled = true
    enabled = ${?NEOGENESIS_RESILIENCE_ENABLED}
    integrationTimeoutMs = 7000
    integrationTimeoutMs = ${?NEOGENESIS_RESILIENCE_TIMEOUT_MS}
    circuitBreakerFailureThreshold = 5
    circuitBreakerFailureThreshold = ${?NEOGENESIS_RESILIENCE_CB_FAILURE_THRESHOLD}
    circuitBreakerOpenStateMs = 30000
    circuitBreakerOpenStateMs = ${?NEOGENESIS_RESILIENCE_CB_OPEN_MS}
    requireIdempotencyKey = true
    requireIdempotencyKey = ${?NEOGENESIS_REQUIRE_IDEMPOTENCY_KEY}
    idempotencyTtlSeconds = 86400
    idempotencyTtlSeconds = ${?NEOGENESIS_IDEMPOTENCY_TTL_SECONDS}
  }

  control {
    latencyBudgetMs = 50
    latencyBudgetMs = ${?NEOGENESIS_CONTROL_LATENCY_BUDGET_MS}
  }

  serverless {
    outboxBatchSize = 100
    outboxBatchSize = ${?NEOGENESIS_SERVERLESS_OUTBOX_BATCH_SIZE}
    dispatchIntervalMs = 2000
    dispatchIntervalMs = ${?NEOGENESIS_SERVERLESS_DISPATCH_INTERVAL_MS}
    provider = "logging"
    provider = ${?NEOGENESIS_SERVERLESS_PROVIDER}
    maxRetries = 5
    maxRetries = ${?NEOGENESIS_SERVERLESS_MAX_RETRIES}
    baseBackoffMs = 500
    baseBackoffMs = ${?NEOGENESIS_SERVERLESS_BASE_BACKOFF_MS}
    maxBackoffMs = 30000
    maxBackoffMs = ${?NEOGENESIS_SERVERLESS_MAX_BACKOFF_MS}
    awsSqs {
      queueUrl = ${?NEOGENESIS_AWS_SQS_QUEUE_URL}
      region = "eu-west-1"
      region = ${?NEOGENESIS_AWS_SQS_REGION}
      endpointOverride = ${?NEOGENESIS_AWS_SQS_ENDPOINT_OVERRIDE}
    }
    awsEventBridge {
      eventBusName = ${?NEOGENESIS_AWS_EVENTBRIDGE_BUS}
      sourceNamespace = "com.neogenesis.core"
      sourceNamespace = ${?NEOGENESIS_AWS_EVENTBRIDGE_SOURCE}
      region = "eu-west-1"
      region = ${?NEOGENESIS_AWS_EVENTBRIDGE_REGION}
      endpointOverride = ${?NEOGENESIS_AWS_EVENTBRIDGE_ENDPOINT_OVERRIDE}
    }
    gcpPubSub {
      projectId = ${?NEOGENESIS_GCP_PUBSUB_PROJECT}
      topicId = ${?NEOGENESIS_GCP_PUBSUB_TOPIC}
      emulatorHost = ${?NEOGENESIS_GCP_PUBSUB_EMULATOR_HOST}
    }
  }

  billing {
    enabled = false
    enabled = ${?BILLING_ENABLED}
    provider = "fake"
    provider = ${?BILLING_PROVIDER}
    freePlanId = "free"
    freePlanId = ${?BILLING_PLAN_FREE_ID}
    proPlanId = "pro"
    proPlanId = ${?BILLING_PLAN_PRO_ID}
    planFeatures {
      free = ""
      free = ${?BILLING_PLAN_FEATURES_FREE}
      pro = "audit:evidence_export,compliance:traceability_audit"
      pro = ${?BILLING_PLAN_FEATURES_PRO}
    }
    stripe {
      secretKey = ${?STRIPE_SECRET_KEY}
      webhookSecret = ${?STRIPE_WEBHOOK_SECRET}
      priceIdFree = ${?STRIPE_PRICE_ID_FREE}
      priceIdPro = ${?STRIPE_PRICE_ID_PRO}
      successUrl = "https://example.com/billing/success"
      successUrl = ${?STRIPE_SUCCESS_URL}
      cancelUrl = "https://example.com/billing/cancel"
      cancelUrl = ${?STRIPE_CANCEL_URL}
      portalReturnUrl = "https://example.com/billing/portal"
      portalReturnUrl = ${?STRIPE_PORTAL_RETURN_URL}
    }
  }
}
